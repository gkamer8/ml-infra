FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    zsh \
    fzf \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Install oh-my-zsh
RUN sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

# Install zsh-autosuggestions plugin
RUN git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions

# Set zsh as default shell
SHELL ["/bin/zsh", "-c"]

# Set working directory
WORKDIR /infra

# Copy dependency files and install dependencies
ENV UV_LINK_MODE=copy
COPY pyproject.toml uv.lock ./
COPY submit ./submit

RUN uv pip install --system -e .

# Default command
CMD ["zsh"]
